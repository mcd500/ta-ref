<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TA-REF: Preparation and building TA-Ref with docker</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">TA-REF
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('a00057.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Preparation and building TA-Ref with docker </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md30"></a>
Preparation</h1>
<p >For building TA-Ref with docker, it is required to install docker on Ubuntu.</p>
<p >For the first time users of docker, please have a look on <a href="https://docs.docker.com/engine/">https://docs.docker.com/engine/</a></p>
<p >The following installation steps is for Ubuntu 20.04</p>
<h2><a class="anchor" id="autotoc_md31"></a>
Installing Docker</h2>
<div class="fragment"><div class="line">$ sudo apt update</div>
<div class="line"> </div>
<div class="line"># Next, install a few prerequisite packages which let apt use packages over HTTPS:</div>
<div class="line">$ sudo apt install apt-transport-https ca-certificates curl software-properties-common</div>
<div class="line"> </div>
<div class="line"># Then add the GPG key for the official Docker repository to your system:</div>
<div class="line">$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</div>
<div class="line"> </div>
<div class="line"># Add the Docker repository to APT sources:</div>
<div class="line">$ sudo add-apt-repository &quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable&quot;</div>
<div class="line"> </div>
<div class="line"># This will also update our package database with the Docker packages from the newly added repo.</div>
<div class="line"># Make sure you are about to install from the Docker repo instead of the default Ubuntu repo:</div>
<div class="line">$ apt-cache policy docker-ce</div>
<div class="line"> </div>
<div class="line">#Finally, install Docker</div>
<div class="line">$ sudo apt install docker-ce</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md32"></a>
Executing Docker without sudo</h2>
<p >By default, the docker command can only be run the root user or by a user in the docker group, which is automatically created during Docker’s installation process. If you attempt to run the docker command without prefixing it with sudo or without being in the docker group, you’ll get an output like this:</p>
<div class="fragment"><div class="line">docker: Cannot connect to the Docker daemon. Is the docker daemon running on this host?.</div>
</div><!-- fragment --><p >To avoid typing sudo whenever we run the docker command, add your username to the docker group.</p>
<div class="fragment"><div class="line">$ sudo groupadd docker</div>
<div class="line"> </div>
<div class="line">$ sudo gpasswd -a $USER docker</div>
<div class="line"> </div>
<div class="line"># Logout and then log-in again to apply the changes to the group</div>
</div><!-- fragment --><p >After you logout and login, you can probably run the docker command without <code>sudo</code></p>
<div class="fragment"><div class="line">$ docker run hello-world</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md33"></a>
Create a docker network tamproto</h2>
<p >A docker network named tamproto is required when we run TA-Ref for Keystone. The local network is required to connect with tamproto service running locally.</p>
<div class="fragment"><div class="line">$ docker network create tamproto_default</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md34"></a>
Docker images details</h1>
<p >The docker images with all necessary packages for building TA-Ref for all three targets are already available. Make sure you have account on docker-hub. If not please create one on <code>dockerhub.com</code> The details are mentioned below</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Target   </th><th class="markdownTableHeadNone">docker image    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Keystone   </td><td class="markdownTableBodyNone">aistcpsec/tee-dev:keystone-1.0.0    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">OP-TEE   </td><td class="markdownTableBodyNone">aistcpsec/tee-dev:optee-3.10.0    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Intel SGX   </td><td class="markdownTableBodyNone">aistcpsec/tee-dev:sgx-2.10   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md35"></a>
Building TA-Ref with Docker</h1>
<h2><a class="anchor" id="autotoc_md36"></a>
Building TA-Ref for Keystone with docker</h2>
<p >Following commands are to be executed on Ubuntu 20.04.</p>
<div class="fragment"><div class="line"># Clone the TA-Ref repo and checkout teep-master branch</div>
<div class="line">$ git clone https://github.com/mcd500/ta-ref.git</div>
<div class="line">$ cd ta-ref/</div>
<div class="line">$ git checkout teep-master</div>
<div class="line"> </div>
<div class="line"># Sync and update the submodules</div>
<div class="line">$ git submodule sync --recursive</div>
<div class="line">$ git submodule update --init --recursive</div>
<div class="line"> </div>
<div class="line"># Start the docker</div>
<div class="line">$ docker run --network tamproto_default -it --rm -v $(pwd):/home/user/ta-ref</div>
<div class="line"> aistcpsec/tee-dev:keystone-1.0.0</div>
</div><!-- fragment --><p >After you start the docker command, you will be logged-in inside the docker container. Following are the commands to be executed inside the docker</p>
<div class="fragment"><div class="line"># [Inside docker image]</div>
<div class="line"> </div>
<div class="line">$ cd ta-ref/</div>
<div class="line">$ source env/keystone.sh</div>
<div class="line"> </div>
<div class="line"># Build test_hello directory</div>
<div class="line">$ make build test-bin MACHINE=SIM TEST_DIR=test_hello</div>
<div class="line"> </div>
<div class="line"># Build test_gp directory</div>
<div class="line">$ make build test-bin MACHINE=SIM TEST_DIR=test_gp</div>
</div><!-- fragment --><p >By the above steps, we have successfully built the TA-Ref. Below we are going to push it into qemu and test its working</p>
<p ><b>Test the built test_hello, test_gp binaries in Qemu</b></p>
<div class="fragment"><div class="line"># Copy the test_hello inside qemu root</div>
<div class="line">$ mkdir $KEYSTONE_DIR/build/overlay/root/test_hello</div>
<div class="line">$ cp test_hello/keystone/App/App.client $KEYSTONE_DIR/build/overlay/root/test_hello/</div>
<div class="line">$ cp test_hello/keystone/Enclave/Enclave.eapp_riscv $KEYSTONE_DIR/build/overlay/root/test_hello/</div>
<div class="line">$ cp $KEYSTONE_SDK_DIR/runtime/eyrie-rt $KEYSTONE_DIR/build/overlay/root/test_hello/</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"># Copy the test_gp inside qemu root</div>
<div class="line">$ mkdir $KEYSTONE_DIR/build/overlay/root/test_gp</div>
<div class="line">$ cp test_gp/keystone/App/App.client $KEYSTONE_DIR/build/overlay/root/test_gp/</div>
<div class="line">$ cp test_gp/keystone/Enclave/Enclave.eapp_riscv $KEYSTONE_DIR/build/overlay/root/test_gp/</div>
<div class="line">$ cp $KEYSTONE_SDK_DIR/runtime/eyrie-rt $KEYSTONE_DIR/build/overlay/root/test_gp/</div>
<div class="line"> </div>
<div class="line"># Re-build the keystone again to copy test_hello and test_gp inside qemu</div>
<div class="line">$ cd $KEYSTONE_DIR/build</div>
<div class="line">$ make</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"># Start the Qemu console from $KEYSTONE_DIR/build dir</div>
<div class="line">$ ./scripts/run-qemu.sh</div>
<div class="line"> </div>
<div class="line"># When asked for username and password use</div>
<div class="line"># username : root</div>
<div class="line"># password : sifive</div>
<div class="line"> </div>
<div class="line"># Inside Qemu run the steps to test test_hello and test_gp</div>
<div class="line"># Load keystone driver</div>
<div class="line">$ insmod keystone-driver.ko</div>
<div class="line"> </div>
<div class="line"># Test test_hello</div>
<div class="line">$ cd test_hello/</div>
<div class="line">$ ./App.client Enclave.eapp_riscv eyrie-rt</div>
<div class="line"> </div>
<div class="line">[debug] UTM : 0xffffffff80000000-0xffffffff80100000 (1024 KB) (boot.c:127)</div>
<div class="line">[debug] DRAM: 0xb7c00000-0xb8000000 (4096 KB) (boot.c:128)</div>
<div class="line">[debug] FREE: 0xb7dbb000-0xb8000000 (2324 KB), va 0xffffffff001bb000 (boot.c:133)</div>
<div class="line">[debug] eyrie boot finished. drop to the user land ... (boot.c:172)</div>
<div class="line">hello world!</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"># Test Test_gp</div>
<div class="line">$ cd ../test_gp/</div>
<div class="line">$ ./App.client Enclave.eapp_riscv eyrie-rt</div>
<div class="line"> </div>
<div class="line">[debug] UTM : 0xffffffff80000000-0xffffffff80100000 (1024 KB) (boot.c:127)</div>
<div class="line">[debug] DRAM: 0xb8000000-0xb8400000 (4096 KB) (boot.c:128)</div>
<div class="line">[debug] FREE: 0xb81dd000-0xb8400000 (2188 KB), va 0xffffffff001dd000 (boot.c:133)</div>
<div class="line">[debug] eyrie boot finished. drop to the user land ... (boot.c:172)</div>
<div class="line">main start</div>
<div class="line">TEE_GenerateRandom(0x000000003FFFFEE0, 16): start</div>
<div class="line">@random: 5c066e270ed690d9f1f0a3ba094def05</div>
<div class="line">TEE_GetREETime(): start</div>
<div class="line">@GP REE time 241 sec 936 millis</div>
<div class="line">TEE_GetSystemTime(): start</div>
<div class="line">@GP System time 1312074212 sec 5 millis</div>
<div class="line">TEE_CreatePersistentObject(): start</div>
<div class="line">TEE_WriteObjectData(): start</div>
<div class="line">TEE_CloseObject(): start</div>
<div class="line">TEE_OpenPersistentObject(): start</div>
<div class="line">TEE_ReadObjectData(): start</div>
<div class="line">TEE_CloseObject(): start</div>
<div class="line">256 bytes read: 000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232</div>
<div class="line">425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f50</div>
<div class="line">5152535455565758595a5b5c5d5e5f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7</div>
<div class="line">d7e7f808182838485868788898a8b8c8d8e8f909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8a9</div>
<div class="line">aaabacadaeafb0b1b2b3b4b5b6b7b8b9babbbcbdbebfc0c1c2c3c4c5c6c7c8c9cacbcccdcecfd0d1d2d3d4d5d</div>
<div class="line">6d7d8d9dadbdcdddedfe0e1e2e3e4e5e6e7e8e9eaebecedeeeff0f1f2f3f4f5f6f7f8f9fafbfcfdfeff</div>
<div class="line">verify ok</div>
<div class="line">TEE_AllocateOperation(): start</div>
<div class="line">TEE_FreeOperation(): start</div>
<div class="line">TEE_DigestDoFinal(): start</div>
<div class="line">TEE_FreeOperation(): start</div>
<div class="line">hash: 9b04c091da96b997afb8f2585d608aebe9c4a904f7d52c8f28c7e4d2dd9fba5f</div>
<div class="line">TEE_AllocateTransientObject(): start</div>
<div class="line">TEE_GenerateKey(): start</div>
<div class="line">TEE_GenerateRandom(0x000000003FFFFD88, 32): start</div>
<div class="line">TEE_AllocateOperation(): start</div>
<div class="line">TEE_GenerateRandom(0x000000003FFFFED0, 16): start</div>
<div class="line">TEE_CipherInit(): start</div>
<div class="line">TEE_CipherUpdate(): start</div>
<div class="line">TEE_FreeOperation(): start</div>
<div class="line">@cipher: 50b5316159d5e023fec5006a079f11117cc82d59e3888ee815cae300b9d7def43fb05ec75912e6e0068</div>
<div class="line">a5fad284797bc61412db0b6395eb1403fd8dd5d81241654811d0e0ed6a52471dcd4958395b669f72b2ee2ab55585</div>
<div class="line">4cd4772c4e4c5b1224c345e1a2b161e048c82e28950220c757ce05cb5339b92d88dc3a8d8318ce0b0280c94c15b7</div>
<div class="line">779bcc456515176a11df946a91c40c124035a475074108f8c819d571384cff43a70fcae958ab6438fbec47bf1585</div>
<div class="line">7b6b1b1ca98edcd8bc88140a6956a62a164e4da1b76f1e36e62402ec6cb6214f1a9b1ed9fbf0505454de33efdde3</div>
<div class="line">71952be81fee1ac47e07203d41ea10024aca056d3010c01d0b1c792851cd7</div>
<div class="line">TEE_AllocateOperation(): start</div>
<div class="line">TEE_CipherInit(): start</div>
<div class="line">TEE_CipherUpdate(): start</div>
<div class="line">TEE_FreeOperation(): start</div>
<div class="line">TEE_FreeTransientObject(): start</div>
<div class="line">decrypted to: 000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f20212223242526</div>
<div class="line">2728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f5051525354</div>
<div class="line">55565758595a5b5c5d5e5f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f808182</div>
<div class="line">838485868788898a8b8c8d8e8f909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8a9aaabacadaeafb0</div>
<div class="line">b1b2b3b4b5b6b7b8b9babbbcbdbebfc0c1c2c3c4c5c6c7c8c9cacbcccdcecfd0d1d2d3d4d5d6d7d8d9dadbdcddde</div>
<div class="line">dfe0e1e2e3e4e5e6e7e8e9eaebecedeeeff0f1f2f3f4f5f6f7f8f9fafbfcfdfeff</div>
<div class="line">verify ok</div>
<div class="line">TEE_AllocateTransientObject(): start</div>
<div class="line">TEE_GenerateKey(): start</div>
<div class="line">TEE_GenerateRandom(0x000000003FFFFC68, 32): start</div>
<div class="line">TEE_AllocateOperation(): start</div>
<div class="line">TEE_GenerateRandom(0x000000003FFFFEC8, 16): start</div>
<div class="line">TEE_AEInit(): start</div>
<div class="line">TEE_AEEncryptFinal(): start</div>
<div class="line">TEE_FreeOperation(): start</div>
<div class="line">@cipher: 5fbd1a14a83504ef595f73c6af425023ec6e6aca5ffb47b2b88666ddb7f8cf17ce32486e1efa7d09a53</div>
<div class="line">369024e936eb9312431ed341feaed8cead7e985fea9baa72092cfd8e1955cd9428dd13fb48431aeae6fef34d200b</div>
<div class="line">7b3e7bd25352e9c2a705a9d1570caf6019ca157f05ce9adec42c313a54162194a691d015564d7199b2f7e3ebf9d5</div>
<div class="line">98ce408a930cf83d50924dcde08a57e110820bbad531612d3730138ca025c209f5ac285625001faffd4344ea3a72</div>
<div class="line">a85d46295de4ca573d1ff8f21754d1faa550ad12f32aa4885f5acaeed96cc795d99768c884402e3462041bd596dd</div>
<div class="line">d676dc154a7ca0c7d654a8670aec8e23486ec9e1897543d754476472fd04e</div>
<div class="line">@tag: 9b8bd6ab05b44879079b894835aaedf1</div>
<div class="line">TEE_AllocateOperation(): start</div>
<div class="line">TEE_AEInit(): start</div>
<div class="line">TEE_AEDecryptFinal(): start</div>
<div class="line">TEE_FreeOperation(): start</div>
<div class="line">TEE_FreeTransientObject(): start</div>
<div class="line">decrypted to: 000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262</div>
<div class="line">728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455</div>
<div class="line">565758595a5b5c5d5e5f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f808182838</div>
<div class="line">485868788898a8b8c8d8e8f909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8a9aaabacadaeafb0b1b2</div>
<div class="line">b3b4b5b6b7b8b9babbbcbdbebfc0c1c2c3c4c5c6c7c8c9cacbcccdcecfd0d1d2d3d4d5d6d7d8d9dadbdcdddedfe0e</div>
<div class="line">1e2e3e4e5e6e7e8e9eaebecedeeeff0f1f2f3f4f5f6f7f8f9fafbfcfdfeff</div>
<div class="line">verify ok</div>
<div class="line">TEE_AllocateOperation(): start</div>
<div class="line">TEE_FreeOperation(): start</div>
<div class="line">TEE_DigestDoFinal(): start</div>
<div class="line">TEE_FreeOperation(): start</div>
<div class="line">@digest: 9b04c091da96b997afb8f2585d608aebe9c4a904f7d52c8f28c7e4d2dd9fba5f</div>
<div class="line">TEE_AllocateOperation(): start</div>
<div class="line">TEE_AllocateTransientObject(): start</div>
<div class="line">TEE_InitValueAttribute(): start</div>
<div class="line">TEE_GenerateKey(): start</div>
<div class="line">TEE_GenerateRandom(0x000000003FFFFE28, 32): start</div>
<div class="line">TEE_AsymmetricSignDigest(): start</div>
<div class="line">TEE_FreeOperation(): start</div>
<div class="line">@signature: 3b018bbf24235c4c367c276beafbf4dcec071ab885b37f3096081e98e8cb03fb97bb637d21c98fc0d60</div>
<div class="line">06fb082d2a8690d6fa8c0fb2ae666670883b83bd27107</div>
<div class="line">TEE_AllocateOperation(): start</div>
<div class="line">TEE_AsymmetricVerifyDigest(): start</div>
<div class="line">TEE_FreeOperation(): start</div>
<div class="line">@@TEE_FreeOperation:</div>
<div class="line">TEE_FreeTransientObject(): start</div>
<div class="line">verify ok</div>
<div class="line">main end</div>
</div><!-- fragment --><p >Poweroff the console incase, if you want to exit. </p><div class="fragment"><div class="line">$ poweroff</div>
</div><!-- fragment --><p> You can also press Ctrl a+x to exit the qemu console.</p>
<h2><a class="anchor" id="autotoc_md37"></a>
Building TA-Ref for OP-TEE with docker</h2>
<p >Following commands are to be executed on Ubuntu 20.04.</p>
<div class="fragment"><div class="line"># Clone the ta-ref repo and checkout teep-master branch</div>
<div class="line">$ git clone https://github.com/mcd500/ta-ref.git</div>
<div class="line">$ cd ta-ref/</div>
<div class="line">$ git checkout teep-master</div>
<div class="line"> </div>
<div class="line"># Sync and update the submodules</div>
<div class="line">$ git submodule sync --recursive</div>
<div class="line">$ git submodule update --init --recursive</div>
<div class="line"> </div>
<div class="line"># Start the docker</div>
<div class="line">$ docker run -it --rm -v $(pwd):/home/user/ta-ref aistcpsec/tee-dev:optee-3.10.0</div>
</div><!-- fragment --><p >After you start the docker command, you will be logged-in inside the docker container. Following are the commands to be executed inside the docker</p>
<div class="fragment"><div class="line"># [Inside docker image]</div>
<div class="line"> </div>
<div class="line">$ cd ta-ref/</div>
<div class="line">$ source env/optee_qemu.sh</div>
<div class="line"> </div>
<div class="line"># Build test_hello directory</div>
<div class="line">$ make build test-bin MACHINE=SIM TEST_DIR=test_hello</div>
<div class="line"> </div>
<div class="line"># Build test_gp directory</div>
<div class="line">$ make build test-bin MACHINE=SIM TEST_DIR=test_gp</div>
</div><!-- fragment --><p >By the above steps, we have successfully built the TA-Ref. Below we are going to push it into qemu and test its working</p>
<p ><b>Test the built test_hello, test_gp binaries in Qemu</b></p>
<div class="fragment"><div class="line"># Extract the rootfs.cpio.gz</div>
<div class="line"># copy the binaries into qemu rootfs directory</div>
<div class="line"># Re-pack the rootfs folder into a cpio archive</div>
<div class="line">$ make install_optee_qemu</div>
<div class="line"> </div>
<div class="line"># Start the Qemu console from $OPTEE_DIR/build directory</div>
<div class="line">$ ln -sf /home/user/optee/out-br/images/rootfs.cpio.gz /home/user/optee/out/bin</div>
<div class="line">$ cd /home/user/optee/out/bin &amp;&amp; \</div>
<div class="line">    /home/user/optee/qemu/aarch64-softmmu/qemu-system-aarch64 \</div>
<div class="line">        -nographic \</div>
<div class="line">        -serial mon:stdio -serial file:serial1.log \</div>
<div class="line">        -smp 2 \</div>
<div class="line">        -machine virt,secure=on -cpu cortex-a57 \</div>
<div class="line">        -d unimp -semihosting-config enable,target=native \</div>
<div class="line">        -m 1057 \</div>
<div class="line">        -bios bl1.bin \</div>
<div class="line">        -initrd rootfs.cpio.gz \</div>
<div class="line">        -kernel Image -no-acpi \</div>
<div class="line">        -append &quot;console=ttyAMA0,38400 keep_bootcon root=/dev/vda2&quot;</div>
<div class="line"> </div>
<div class="line"># If you face any error like</div>
<div class="line"># qemu-system-aarch64: keep_bootcon: Could not open &#39;keep_bootcon&#39;: No such file or directory</div>
<div class="line"># Just replace the double quotes in the last line with single quotes.</div>
<div class="line"> </div>
<div class="line"># When asked for builroot login, please enter root</div>
<div class="line"># buildroot login: root</div>
<div class="line"> </div>
<div class="line"># Inside Qemu run the steps to test test_hello and test_gp</div>
<div class="line"># Test test_hello</div>
<div class="line">$ cd test_hello/</div>
<div class="line">$ cp a6f77c1e-96fe-4a0e-9e74-262582a4c8f1.ta /lib/optee_armtz/</div>
<div class="line">$ ./optee_ref_ta</div>
<div class="line"> </div>
<div class="line">--- enclave log start---</div>
<div class="line">ecall_ta_main() start</div>
<div class="line">hello world!</div>
<div class="line">ecall_ta_main() end</div>
<div class="line"> </div>
<div class="line">--- enclave log end---</div>
<div class="line">#</div>
<div class="line"> </div>
<div class="line"># Test test_gp</div>
<div class="line">$ cd ../test_gp/</div>
<div class="line">$ cp a6f77c1e-96fe-4a0e-9e74-262582a4c8f1.ta /lib/optee_armtz/</div>
<div class="line">$ ./optee_ref_ta</div>
<div class="line"> </div>
<div class="line">start TEEC_InvokeCommand</div>
<div class="line">--- enclave log start---</div>
<div class="line">ecall_ta_main() start</div>
<div class="line">@random: 3efa2690dc1857e1a45ee256fac75917</div>
<div class="line">@GP REE time 1643004179 sec 669 millis</div>
<div class="line">@GP System time 71 sec 804 millis</div>
<div class="line">256 bytes read: 000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f2021222</div>
<div class="line">32425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e</div>
<div class="line">4f505152535455565758595a5b5c5d5e5f606162636465666768696a6b6c6d6e6f707172737475767778797</div>
<div class="line">a7b7c7d7e7f808182838485868788898a8b8c8d8e8f909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5</div>
<div class="line">a6a7a8a9aaabacadaeafb0b1b2b3b4b5b6b7b8b9babbbcbdbebfc0c1c2c3c4c5c6c7c8c9cacbcccdcecfd0d</div>
<div class="line">1d2d3d4d5d6d7d8d9dadbdcdddedfe0e1e2e3e4e5e6e7e8e9eaebecedeeeff0f1f2f3f4f5f6f7f8f9fafbfc</div>
<div class="line">fdfeff</div>
<div class="line">verify ok</div>
<div class="line">hash: 40aff2e9d2d8922e47afd4648e6967497158785fbd1da870e7110266bf944880</div>
<div class="line">@cipher: 1a5004415312bf2ae919686a94aeaed65bc44a84724c12871945636443f03236104e406a12d5dc1</div>
<div class="line">78b20a797b00fc38e42338e748ea60add29bbfc9c4253db4768114e019ed632408009a05cf21191e74faba54</div>
<div class="line">4510290fca5cccc16e1befdf456c73c4e564adbde6704b4a8d8ef9d910bb0cd38653ab04eba9aa332abd2274</div>
<div class="line">b6e5ea01563ff604f2ce4e7b11495b264bf9b6fd2692c609186f3413f8b893ea0b1c826f6d74da8dcb92d6d2</div>
<div class="line">367ec0dfd1874c5e9f226e6f08a3a81431d944a35c46023f72dc2538f71dcd831282111b716723b4a178fa92</div>
<div class="line">5bd901474b7392c5f7a06c0ecb7ce975677369eebeffbcfed4aa8b08d4974241ba9df0008f061395d</div>
<div class="line">decrypted to: 000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f2021222324</div>
<div class="line">25262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f50</div>
<div class="line">5152535455565758595a5b5c5d5e5f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c</div>
<div class="line">7d7e7f808182838485868788898a8b8c8d8e8f909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8</div>
<div class="line">a9aaabacadaeafb0b1b2b3b4b5b6b7b8b9babbbcbdbebfc0c1c2c3c4c5c6c7c8c9cacbcccdcecfd0d1d2d3d4</div>
<div class="line">d5d6d7d8d9dadbdcdddedfe0e1e2e3e4e5e6e7e8e9eaebecedeeeff0f1f2f3f4f5f6f7f8f9fafbfcfdfeff</div>
<div class="line">verify ok</div>
<div class="line">@cipher: 0d3296d0049822159014b5cf781415ac6c43a57cf7d1e61abbc54eca7a802cd47c4b9f470017eff</div>
<div class="line">d2511b310b3e1bf5093a52a0a2370ac354cd97cd984bb5cf7fdeba3009b69fbded49ac8789a4ada774436807</div>
<div class="line">fe8452888fbf26eee36332894be13e7ff1ea60e02dfcc9b43a39c0088be43a871a342c119963859936c8bbce</div>
<div class="line">4ffc215c1d7115d28fa2fef08cdca0e38131e967824ffa30a072ba8f7d66d2795e19beb08e32ffaf2b2a92d8</div>
<div class="line">2a0b3ef796cbb1c290512963617abb5ecc31f14747e204057e3a90ad3e561efba681d58e0b7bb69c5a6a5250</div>
<div class="line">c892bceb3dfc9d8c79e644a7aa234c4f5e7d94fb4867bd97d6dc8f26443345995802a9a320a64c22b</div>
<div class="line">@tag: a38fd49dc4c3f453f35db8af29d8e371</div>
<div class="line">decrypted to: 000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f2021222324</div>
<div class="line">25262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f50</div>
<div class="line">5152535455565758595a5b5c5d5e5f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c</div>
<div class="line">7d7e7f808182838485868788898a8b8c8d8e8f909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8</div>
<div class="line">a9aaabacadaeafb0b1b2b3b4b5b6b7b8b9babbbcbdbebfc0c1c2c3c4c5c6c7c8c9cacbcccdcecfd0d1d2d3d4</div>
<div class="line">d5d6d7d8d9dadbdcdddedfe0e1e2e3e4e5e6e7e8e9eaebecedeeeff0f1f2f3f4f5f6f7f8f9fafbfcfdfeff</div>
<div class="line">verify ok</div>
<div class="line">@digest: 40aff2e9d2d8922e47afd4648e6967497158785fbd1da870e7110266bf944880</div>
<div class="line">@signature: a43c693ccede4504bc921c41ad9c937cd5ed3bab2494a72079f51deffb4d32d3840f55e699aa3</div>
<div class="line">ec092e033efd4662bb702c6de4cb338f65bd015647d5a10bc62</div>
<div class="line">@@TEE_FreeOperation:</div>
<div class="line">verify ok</div>
<div class="line">ecall_ta_main() end</div>
<div class="line"> </div>
<div class="line">--- enclave log end---</div>
<div class="line">res = TEEC_SUCCESS; TEEC_InvokeCommand succeeded!</div>
<div class="line">#</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md38"></a>
Building TA-Ref for Intel SGX with docker</h2>
<p >Following commands are to be executed on Ubuntu 20.04.</p>
<div class="fragment"><div class="line"># Clone the ta-ref repo and checkout teep-master branch</div>
<div class="line">$ git clone https://github.com/mcd500/ta-ref.git</div>
<div class="line">$ cd ta-ref/</div>
<div class="line">$ git checkout teep-master</div>
<div class="line"> </div>
<div class="line"># Sync and update the submodules</div>
<div class="line">$ git submodule sync --recursive</div>
<div class="line">$ git submodule update --init --recursive</div>
<div class="line"> </div>
<div class="line"># Start the docker</div>
<div class="line">$ docker run -it --rm -v $(pwd):/home/user/ta-ref aistcpsec/tee-dev:sgx-2.10</div>
</div><!-- fragment --><p >Commands to be executed inside docker:</p>
<div class="fragment"><div class="line">$ cd ta-ref/</div>
<div class="line"> </div>
<div class="line"># Source SGX environment variables</div>
<div class="line">$ source /opt/intel/sgxsdk/environment</div>
<div class="line">$ source env/sgx_x64.sh</div>
<div class="line"> </div>
<div class="line"># Build test_hello directory</div>
<div class="line">$ make build test-bin MACHINE=SIM TEST_DIR=test_hello</div>
<div class="line"> </div>
<div class="line"># Build test_gp directory</div>
<div class="line">$ make build test-bin MACHINE=SIM TEST_DIR=test_gp</div>
</div><!-- fragment --><p >By the above steps, we have successfully built the TA-Ref. Since we are building in SIM mode, We can execute in docker itself.</p>
<p >There are two files required to test_hello 1) ./sgx_app 2)enclave.signed.so copy the files into a directory and then execute the ./sgx_app command</p>
<p ><b>Test the built test_hello, test_gp binaries in Docker SIM mode</b></p>
<p >Make sure test_hello is already built in SIM mode. [Inside /home/user directory]</p>
<p >Test_hello:</p>
<div class="fragment"><div class="line">$ cd test_hello/</div>
<div class="line"> </div>
<div class="line"># Copy the sgx_app for test_hello</div>
<div class="line">$ cp sgx/App/sgx_app .</div>
<div class="line"># Copy the enclave</div>
<div class="line">$ cp sgx/Enclave/enclave.signed.so .</div>
<div class="line"> </div>
<div class="line"># Run the program</div>
<div class="line">$ ./sgx_app</div>
<div class="line"> </div>
<div class="line"># [trimmed output]</div>
<div class="line">hello world!</div>
<div class="line">Info: Enclave successfully returned.</div>
</div><!-- fragment --><p >Test_gp:</p>
<p >Make sure test_hello is already built in SIM mode. [Inside /home/user directory]</p>
<div class="fragment"><div class="line">$ cd test_gp/</div>
<div class="line"> </div>
<div class="line"># Copy the sgx_app for test_gp</div>
<div class="line">$ cp sgx/App/sgx_app .</div>
<div class="line"># Copy the enclave</div>
<div class="line">$ cp sgx/Enclave/enclave.signed.so .</div>
<div class="line"> </div>
<div class="line"># Run the program</div>
<div class="line">$ ./sgx_app</div>
<div class="line"> </div>
<div class="line"># [trimmed output]</div>
<div class="line">main start</div>
<div class="line">TEE_GenerateRandom(): start</div>
<div class="line">@random: 59af0039e8013fd0cc698c4115b682a3</div>
<div class="line">TEE_GetREETime(): start</div>
<div class="line">request to get unix time 1642994685, 852</div>
<div class="line">@GP REE time 1642994685 sec 852 millis</div>
<div class="line">TEE_GetSystemTime(): start</div>
<div class="line">@GP System time 2624667013 sec 537 millis</div>
<div class="line">TEE_CreatePersistentObject(): start</div>
<div class="line">request to open FileOne flags 241 -&gt; 3</div>
<div class="line">TEE_WriteObjectData(): start</div>
<div class="line">request to write 256 bytes to descriptor 3</div>
<div class="line">TEE_CloseObject(): start</div>
<div class="line">request to close descriptor 3</div>
<div class="line">TEE_OpenPersistentObject(): start</div>
<div class="line">request to open FileOne flags 0 -&gt; 3</div>
<div class="line">TEE_ReadObjectData(): start</div>
<div class="line">request to read 256 bytes from descriptor 3</div>
<div class="line">TEE_CloseObject(): start</div>
<div class="line">request to close descriptor 3</div>
<div class="line">256 bytes read: 000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728</div>
<div class="line">292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f50515253545556575859</div>
<div class="line">5a5b5c5d5e5f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f808182838485868788898a</div>
<div class="line">8b8c8d8e8f909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8a9aaabacadaeafb0b1b2b3b4b5b6b7b8b9babb</div>
<div class="line">bcbdbebfc0c1c2c3c4c5c6c7c8c9cacbcccdcecfd0d1d2d3d4d5d6d7d8d9dadbdcdddedfe0e1e2e3e4e5e6e7e8e9eaebec</div>
<div class="line">edeeeff0f1f2f3f4f5f6f7f8f9fafbfcfdfeff</div>
<div class="line">verify ok</div>
<div class="line">TEE_AllocateOperation(): start</div>
<div class="line">TEE_FreeOperation(): start</div>
<div class="line">TEE_DigestDoFinal(): start</div>
<div class="line">TEE_FreeOperation(): start</div>
<div class="line">hash: 9b04c091da96b997afb8f2585d608aebe9c4a904f7d52c8f28c7e4d2dd9fba5f</div>
<div class="line">TEE_AllocateTransientObject(): start</div>
<div class="line">TEE_GenerateKey(): start</div>
<div class="line">TEE_GenerateRandom(): start</div>
<div class="line">TEE_AllocateOperation(): start</div>
<div class="line">TEE_GenerateRandom(): start</div>
<div class="line">TEE_CipherInit(): start</div>
<div class="line">TEE_CipherUpdate(): start</div>
<div class="line">TEE_FreeOperation(): start</div>
<div class="line">@cipher: 8fc07ed506c8616090c591ada2836179ba21c2b2d79f87600f57d64b489846808f0d0609a808c1184f37c5766</div>
<div class="line">a0d92bc3d0db2d2644b788ae4ba4d2b7073757f6c948611a1163b166a6491aceefbab9f1655a754a610e3ffea5d7e8eac1</div>
<div class="line">936399eaa91e0b2a804788996ebbda7d98988dec8458038c23ab4b2ec7c51eff0f04da2b5c5023b63093aa6b4181b5d2b3</div>
<div class="line">fe724aa3ac9eaeb557bfeef4bec0dbba9f000e877641b60cf450a15b9fda70526f1023e7889607d5d8b4a9e559f6e2779c</div>
<div class="line">925fd997d9431820c3d30593eabd3fd1b80d6ece5cb54edacac0560363546e9d330add6cb2c0daeb843eddfb299eeca505</div>
<div class="line">298ae1a5100e58a46bce4502745a5ed</div>
<div class="line">TEE_AllocateOperation(): start</div>
<div class="line">TEE_CipherInit(): start</div>
<div class="line">TEE_CipherUpdate(): start</div>
<div class="line">TEE_FreeOperation(): start</div>
<div class="line">TEE_FreeTransientObject(): start</div>
<div class="line">decrypted to: 000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292</div>
<div class="line">a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b</div>
<div class="line">5c5d5e5f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8</div>
<div class="line">d8e8f909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8a9aaabacadaeafb0b1b2b3b4b5b6b7b8b9babbbcbdbe</div>
<div class="line">bfc0c1c2c3c4c5c6c7c8c9cacbcccdcecfd0d1d2d3d4d5d6d7d8d9dadbdcdddedfe0e1e2e3e4e5e6e7e8e9eaebecedeeeff</div>
<div class="line">0f1f2f3f4f5f6f7f8f9fafbfcfdfeff</div>
<div class="line">verify ok</div>
<div class="line">TEE_AllocateTransientObject(): start</div>
<div class="line">TEE_GenerateKey(): start</div>
<div class="line">TEE_GenerateRandom(): start</div>
<div class="line">TEE_AllocateOperation(): start</div>
<div class="line">TEE_GenerateRandom(): start</div>
<div class="line">TEE_AEInit(): start</div>
<div class="line">TEE_AEEncryptFinal(): start</div>
<div class="line">TEE_FreeOperation(): start</div>
<div class="line">@cipher: db9dbbc85217721dc3b7901f18bb90dff2f23044f34b932805ef4f36be6602122b61281074fb483f4710d7e1576</div>
<div class="line">a67a2377c5ea13fb976ae041b0cec9d49e60cd6cfa869c0700ffff54a02c8b22f11add2824d5f7fb4898cb28a269db083cd8</div>
<div class="line">d49c6183691202eafa5b81d0167b7f46df3c51a28ed4dc146321a909d624d34fe64ee38189617f9f2df636f7e77a79cc105b</div>
<div class="line">ad81a64b3a756c092d4f8d4f78c302d8411952bdb3fee378f4c12c51b6158b6b633c9cffc3c0dab4cad0aa3a63036e420437</div>
<div class="line">45bf04eb9c2e852bfcc3dc0ff1dfb516c62aa12f0bc2e01073ff1198f0d9d85c7e2d1c52f321cca5536fef8f7be661fd3ce2</div>
<div class="line">466ba20c17214bba2eb62</div>
<div class="line">@tag: b462f462e0b7eb0382cd2eba81d976d5</div>
<div class="line">TEE_AllocateOperation(): start</div>
<div class="line">TEE_AEInit(): start</div>
<div class="line">TEE_AEDecryptFinal(): start</div>
<div class="line">TEE_FreeOperation(): start</div>
<div class="line">TEE_FreeTransientObject(): start</div>
<div class="line">decrypted to: 000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2</div>
<div class="line">b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d</div>
<div class="line">5e5f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f9</div>
<div class="line">09192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8a9aaabacadaeafb0b1b2b3b4b5b6b7b8b9babbbcbdbebfc0c1c2</div>
<div class="line">c3c4c5c6c7c8c9cacbcccdcecfd0d1d2d3d4d5d6d7d8d9dadbdcdddedfe0e1e2e3e4e5e6e7e8e9eaebecedeeeff0f1f2f3f4f</div>
<div class="line">5f6f7f8f9fafbfcfdfeff</div>
<div class="line">verify ok</div>
<div class="line">TEE_AllocateOperation(): start</div>
<div class="line">TEE_FreeOperation(): start</div>
<div class="line">TEE_DigestDoFinal(): start</div>
<div class="line">TEE_FreeOperation(): start</div>
<div class="line">@digest: 9b04c091da96b997afb8f2585d608aebe9c4a904f7d52c8f28c7e4d2dd9fba5f</div>
<div class="line">TEE_AllocateOperation(): start</div>
<div class="line">TEE_AllocateTransientObject(): start</div>
<div class="line">TEE_InitValueAttribute(): start</div>
<div class="line">TEE_GenerateKey(): start</div>
<div class="line">TEE_GenerateRandom(): start</div>
<div class="line">TEE_AsymmetricSignDigest(): start</div>
<div class="line">TEE_FreeOperation(): start</div>
<div class="line">@signature: 62077f18091b203c70318ad9830e41a947aa644208cfedd3dc3889b6321738dafd15f1f3dc531128672da50a5d</div>
<div class="line">88f5dd82d09f026be004c8d6f41a8dbc80da04</div>
<div class="line">TEE_AllocateOperation(): start</div>
<div class="line">TEE_AsymmetricVerifyDigest(): start</div>
<div class="line">TEE_FreeOperation(): start</div>
<div class="line">@@TEE_FreeOperation:</div>
<div class="line">TEE_FreeTransientObject(): start</div>
<div class="line">verify ok</div>
<div class="line">main end</div>
<div class="line">Info: Enclave successfully returned.</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4 </li>
  </ul>
</div>
</body>
</html>
