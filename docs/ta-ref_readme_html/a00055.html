<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TA-REF: How to write your first &#39;Hello World&#39; TA Program</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">TA-REF
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('a00055.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">How to write your first 'Hello World' TA Program </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >To understand how to write TA,We are going to write a simple 'Hello World' TA program. The objective of the program is to print the text 'Hello World'.</p>
<p >To do that, first we will copy the existing sample program from ta-ref <code>samples</code> directory</p>
<p >Have a look on the directory structure of sample program inside ta-ref directory. </p><div class="fragment"><div class="line">build-user@39ddcd17144c:~/ta-ref$ tree hello_world_ta/</div>
<div class="line">hello_world_ta/</div>
<div class="line">├── App-keystone.cpp</div>
<div class="line">├── App-optee.c</div>
<div class="line">├── App-sgx.cpp</div>
<div class="line">├── build-keystone</div>
<div class="line">│    └── Makefile</div>
<div class="line">├── build-optee</div>
<div class="line">│    ├── app.mk</div>
<div class="line">│    ├── enclave.mk</div>
<div class="line">│    ├── Makefile</div>
<div class="line">│    ├── sub.mk</div>
<div class="line">│    └── user_ta_header_defines.h</div>
<div class="line">├── build-sgx</div>
<div class="line">│    ├── app.mk</div>
<div class="line">│    ├── config</div>
<div class="line">│    │    └── Enclave.config.xml</div>
<div class="line">│    ├── Enclave.lds</div>
<div class="line">│    ├── enclave.mk</div>
<div class="line">│    ├── Enclave_private.pem</div>
<div class="line">│    └── Makefile</div>
<div class="line">└── Enclave.c</div>
</div><!-- fragment --><p >Basically we need to modify two files</p>
<p >1) Enclave.c (Common to all three targets)</p>
<p >2) App-&lt;target&gt;.c</p><ul>
<li>App-keystone.cpp (incase of Keystone)</li>
<li>App-optee.c (Incase of OP-TEE)</li>
<li>App-sgx.cpp (Incase of SGX)</li>
</ul>
<h1><a class="anchor" id="autotoc_md18"></a>
Writing 'Hello World' TA for Keystone</h1>
<p ><b>Step 1: Run the Docker image</b></p>
<p >Run the TA-Ref pre-built Docker for keystone.</p>
<div class="fragment"><div class="line"># Download / Refresh the docker image</div>
<div class="line">$ docker pull trasioteam/taref-dev:keystone</div>
<div class="line"> </div>
<div class="line"># Run the docker image</div>
<div class="line">$ docker run -it trasioteam/taref-dev:keystone</div>
</div><!-- fragment --><p ><b>Step 2: Copy sample directory and modify</b></p>
<p >Copy the sample 'message_digest' and rename to the name you need. Here, we are naming it to <code>hello_world_ta</code></p>
<div class="fragment"><div class="line">$ cd ${USER_DIR}</div>
<div class="line">$ cp -r ${TAREF_DIR}/samples/message_digest/ hello_world_ta</div>
<div class="line">$ cd hello_world_ta</div>
</div><!-- fragment --><p ><b>Step 3 : Modifications to Enclave.c (Common to all three targets)</b></p>
<p ><code>Enclave.c</code> is the place where we write the business logic. In our case, our business logic is to print the text 'Hello World'.</p>
<p >Look for the #define statement <code>TA_InvokeCommandEntryPoint()</code> function. This is the place we are going to modify</p>
<p >Before modification</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define TA_REF_HASH_GEN    0x11111111</span></div>
<div class="line"><span class="preprocessor">#define TA_REF_HASH_CHECK  0x22222222</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">TEE_Result TA_InvokeCommandEntryPoint(<span class="keywordtype">void</span> *sess_ctx,</div>
<div class="line">                                      uint32_t cmd_id,</div>
<div class="line">                                      uint32_t param_types, TEE_Param params[4])</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret = TEE_SUCCESS;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">switch</span> (cmd_id) {</div>
<div class="line">    <span class="keywordflow">case</span> TA_REF_HASH_GEN:</div>
<div class="line">        message_digest_gen();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> TEE_SUCCESS;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">case</span> TA_REF_HASH_CHECK:</div>
<div class="line">        ret = message_digest_check();</div>
<div class="line">        <span class="keywordflow">if</span> (ret != TEE_SUCCESS)</div>
<div class="line">            ret = TEE_ERROR_SIGNATURE_INVALID;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> ret;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">        <span class="keywordflow">return</span> TEE_ERROR_BAD_PARAMETERS;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p >After Modification</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define TA_REF_PRINT_HELLO    0x11111111</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">TEE_Result TA_InvokeCommandEntryPoint(<span class="keywordtype">void</span> *sess_ctx,</div>
<div class="line">                                      uint32_t cmd_id,</div>
<div class="line">                                      uint32_t param_types, TEE_Param params[4])</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret = TEE_SUCCESS;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">switch</span> (cmd_id) {</div>
<div class="line">    <span class="keywordflow">case</span> TA_REF_PRINT_HELLO:</div>
<div class="line"> </div>
<div class="line">        tee_printf(<span class="stringliteral">&quot;Hello World \n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> TEE_SUCCESS;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">        <span class="keywordflow">return</span> TEE_ERROR_BAD_PARAMETERS;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p >In the modification, we have removed the existing switch cases and added a new case to print 'Hello World' text. Various functions available to be used here are shown in Chapter 2 and few important functions are explained in detail below.</p>
<p >Please save your changes and exit Enclave.c</p>
<p ><b>Step 4 : Modifications to App-keystone.c</b></p>
<p >App-keystone.cpp is the main function which invokes Enclave.c. The objective is to call the TA_InvokeCommandEntryPoint() which we modified in the previous step.</p>
<p >Before Modification</p>
<div class="fragment"><div class="line"><span class="preprocessor">  #define TA_REF_HASH_GEN    0x11111111</span></div>
<div class="line"><span class="preprocessor">  #define TA_REF_HASH_CHECK  0x22222222</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Inside main() function</span></div>
<div class="line"> </div>
<div class="line">run_enclave(TA_REF_HASH_GEN);</div>
<div class="line">run_enclave(TA_REF_HASH_CHECK);</div>
</div><!-- fragment --><p >After modification </p><div class="fragment"><div class="line"><span class="preprocessor">#define TA_REF_PRINT_HELLO    0x11111111</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Inside main() function</span></div>
<div class="line"> </div>
<div class="line">run_enclave(TA_REF_PRINT_HELLO);</div>
</div><!-- fragment --><p ><b>Step 5: Execute the 'Hello World' TA for Keystone</b></p>
<p >Change directory to the <code>build-keystone</code> directory.</p>
<div class="fragment"><div class="line"># Change to build-&lt;target&gt; directory</div>
<div class="line">$ cd build-keystone</div>
<div class="line"> </div>
<div class="line"># Make the TA</div>
<div class="line">$ make</div>
<div class="line"> </div>
<div class="line"># Run the qemu console</div>
<div class="line">$ make run-qemu</div>
<div class="line"> </div>
<div class="line"># This opens us qemu console and login using</div>
<div class="line"># buildroot login: root</div>
<div class="line"># Password: sifive</div>
<div class="line">#</div>
<div class="line"> </div>
<div class="line"># [Inside Qemu Console]</div>
<div class="line"># Execute the sample and see the output</div>
<div class="line"># Load the keystone driver</div>
<div class="line">$ insmod keystone-driver.ko</div>
<div class="line"> </div>
<div class="line"># Run the message-digest program</div>
<div class="line">$./App-keystone</div>
<div class="line"> </div>
<div class="line"># [Ouput log printing Hello world]</div>
<div class="line">[debug] UTM : 0xffffffff80000000-0xffffffff80100000 (1024 KB) (boot.c:127)</div>
<div class="line">[debug] DRAM: 0x179800000-0x179c00000 (4096 KB) (boot.c:128)</div>
<div class="line">[debug] FREE: 0x1799dd000-0x179c00000 (2188 KB), va 0xffffffff001dd000 (boot.c:133)</div>
<div class="line">[debug] eyrie boot finished. drop to the user land ... (boot.c:172)</div>
<div class="line">main start</div>
<div class="line">Hello World</div>
<div class="line">main end</div>
<div class="line"> </div>
<div class="line"># Exit the qemu console by clicking Ctrl-A X or $ poweroff command</div>
<div class="line">### Ctrl-a x</div>
</div><!-- fragment --><p >Here you can see the text 'Hello World' printed in the log.</p>
<h1><a class="anchor" id="autotoc_md19"></a>
Writing 'Hello World' TA for OP-TEE</h1>
<p ><b>Step 1: Run the Docker image</b></p>
<p >Run the TA-Ref pre-built Docker for optee.</p>
<div class="fragment"><div class="line"># Download / Refresh the docker image</div>
<div class="line">$ docker pull trasioteam/taref-dev:optee</div>
<div class="line"> </div>
<div class="line"># Run the docker image</div>
<div class="line">$ docker run -it trasioteam/taref-dev:optee</div>
</div><!-- fragment --><p ><b>Step 2: Copy sample directory and modify</b></p>
<p >Copy the sample 'message_digest' and rename to the name you need. Here, we are naming it to <code>hello_world_ta</code></p>
<div class="fragment"><div class="line">$ cd ${USER_DIR}</div>
<div class="line">$ cp -r ${TAREF_DIR}/samples/message_digest/ hello_world_ta</div>
<div class="line">$ cd hello_world_ta</div>
</div><!-- fragment --><p ><b>Step 3 : Modifications to Enclave.c</b></p>
<p >The modification is same as Keystone. So please refer the Step 3 of Writing 'Hello World' TA for keystone.</p>
<p ><b>Step 4 : Modification to App-optee.cpp</b></p>
<p >App-optee.c is the main function which invokes Enclave.c. The objective is to call the TA_InvokeCommandEntryPoint() which we modified in the previous step.</p>
<p >Look for the #define statement and <code>main(void)</code> function in the program</p>
<p >Before modification </p><div class="fragment"><div class="line"><span class="preprocessor">#define TA_REF_HASH_GEN    0x11111111</span></div>
<div class="line"><span class="preprocessor">#define TA_REF_HASH_CHECK  0x22222222</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Inside main(void) function</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">res = TEEC_InvokeCommand(&amp;sess, TA_REF_HASH_GEN, &amp;op,</div>
<div class="line">                         &amp;err_origin);</div>
<div class="line"> </div>
<div class="line">res = TEEC_InvokeCommand(&amp;sess, TA_REF_HASH_CHECK, &amp;op,</div>
<div class="line">                         &amp;err_origin);</div>
</div><!-- fragment --><p >After modification </p><div class="fragment"><div class="line"><span class="preprocessor">#define TA_REF_PRINT_HELLO    0x11111111</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Inside main(void) function</span></div>
<div class="line"> </div>
<div class="line">res = TEEC_InvokeCommand(&amp;sess, TA_REF_PRINT_HELLO, &amp;op,</div>
<div class="line">                         &amp;err_origin);</div>
</div><!-- fragment --><p ><b>Step 5: Execute the 'Hello World' TA for OP-TEE</b></p>
<p >Change directory to the <code>build-optee</code> directory.</p>
<div class="fragment"><div class="line"># Change to build-&lt;target&gt; directory</div>
<div class="line">$ cd build-optee</div>
<div class="line"> </div>
<div class="line"># Make the TA</div>
<div class="line">$ make</div>
<div class="line"> </div>
<div class="line"># After successful make of TA, Make the qemu</div>
<div class="line">$ make install_qemu</div>
<div class="line"> </div>
<div class="line"># Run the qemu console</div>
<div class="line">$ make run-qemu</div>
<div class="line"> </div>
<div class="line"># This opens us qemu console and login using</div>
<div class="line"># buildroot login: root</div>
<div class="line"> </div>
<div class="line"># [Inside Qemu Console]</div>
<div class="line"># Execute the create TA program</div>
<div class="line"># No ouput is shown inside qemu, its stored in serial.log</div>
<div class="line"># ./App-optee</div>
<div class="line"> </div>
<div class="line"># Exit the qemu console by clicking Ctrl-A X or $ poweroff command</div>
<div class="line">### Ctrl-a x</div>
</div><!-- fragment --><p >To view the output, open the serial log file by executing the following command outside qemu. </p><div class="fragment"><div class="line">$ cat /home/user/optee/out/bin/serial1.log</div>
<div class="line"> </div>
<div class="line">[Trimmed output]</div>
<div class="line">D/TC:? 0 tee_ta_close_session:518 Destroy session</div>
<div class="line">**Hello World**</div>
<div class="line">D/TC:? 0 tee_ta_close_session:499 csess 0x3293e860 id 1</div>
<div class="line">D/TC:? 0 tee_ta_close_session:518 Destroy session</div>
</div><!-- fragment --><p >Here you can see the text 'Hello World' printed in the log.</p>
<h1><a class="anchor" id="autotoc_md20"></a>
Writing 'Hello World' TA for Intel SGX</h1>
<p ><b>Step 1: Run the Docker image</b></p>
<p >Run the TA-Ref pre-built Docker for sgx.</p>
<div class="fragment"><div class="line"># Download / Refresh the docker image</div>
<div class="line">$ docker pull trasioteam/taref-dev:sgx</div>
<div class="line"> </div>
<div class="line"># Run the docker image</div>
<div class="line">$ docker run -it trasioteam/taref-dev:sgx</div>
</div><!-- fragment --><p ><b>Step 2: Copy sample directory and modify</b></p>
<p >Copy the sample 'message_digest' and rename to the name you need. Here, we are naming it to <code>hello_world_ta</code></p>
<div class="fragment"><div class="line">$ cd ${USER_DIR}</div>
<div class="line">$ cp -r ${TAREF_DIR}/samples/message_digest/ hello_world_ta</div>
<div class="line">$ cd hello_world_ta</div>
</div><!-- fragment --><p ><b>Step 3 : Modifications to Enclave.c</b></p>
<p >The modification is same as Keystone. So please refer the Step 3 of Writing 'Hello World' TA for keystone.</p>
<p ><b>Step 4 : Modification to App-sgx.cpp</b></p>
<p >App-sgx.c is the main function which invokes Enclave.c. The objective is to call the TA_InvokeCommandEntryPoint() which we modified in the previous step.</p>
<p >Look for the #define statement and <code>main(void)</code> function in the program</p>
<p >Before modification </p><div class="fragment"><div class="line"><span class="preprocessor">#define TA_REF_HASH_GEN    0x11111111</span></div>
<div class="line"><span class="preprocessor">#define TA_REF_HASH_CHECK  0x22222222</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Inside main(void) function</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Calling Trusted Application */</span></div>
<div class="line">ret = ecall_ta_main(global_eid, TA_REF_HASH_GEN);</div>
<div class="line"><span class="keywordflow">if</span> (ret != SGX_SUCCESS)</div>
<div class="line">    <span class="keywordflow">goto</span> main_out;</div>
<div class="line">ret = ecall_ta_main(global_eid, TA_REF_HASH_CHECK);</div>
<div class="line"><span class="keywordflow">if</span> (ret != SGX_SUCCESS)</div>
<div class="line">    <span class="keywordflow">goto</span> main_out;</div>
</div><!-- fragment --><p >After modification </p><div class="fragment"><div class="line"><span class="preprocessor">#define TA_REF_PRINT_HELLO    0x11111111</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Inside main(void) function</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Calling Trusted Application */</span></div>
<div class="line">ret = ecall_ta_main(global_eid, TA_REF_PRINT_HELLO);</div>
<div class="line"><span class="keywordflow">if</span> (ret != SGX_SUCCESS)</div>
<div class="line">    <span class="keywordflow">goto</span> main_out;</div>
</div><!-- fragment --><p ><b>Step 5: Execute the 'Hello World' TA for Intel SGX</b></p>
<p >Change directory to the <code>build-sgx</code> directory.</p>
<div class="fragment"><div class="line"># Change to build-&lt;target&gt; directory</div>
<div class="line">$ cd build-sgx</div>
<div class="line"> </div>
<div class="line"># Make the message-digest sample for Simulation mode</div>
<div class="line">$ make</div>
<div class="line"> </div>
<div class="line"># This creates the App_sgx and enclave.signed.so</div>
<div class="line"># You can copy this two files alone to any places and run the App_sgx</div>
<div class="line">$ ./App_sgx</div>
<div class="line"> </div>
<div class="line"># [Trimmed Output]</div>
<div class="line">main start</div>
<div class="line">Hello World</div>
<div class="line">main end</div>
<div class="line">Info: Enclave successfully returned.</div>
</div><!-- fragment --><p >Here you can see the text 'Hello World' printed in the log. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4 </li>
  </ul>
</div>
</body>
</html>
