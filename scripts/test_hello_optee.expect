#!/usr/bin/expect -f
#

set timeout 480

puts "Starting QEMU..."

spawn $::env(QEMU) \
    -nographic \
		-serial mon:stdio -serial file:serial1.log \
		-smp $::env(QEMU_SMP) \
		-machine virt,secure=on -cpu cortex-a57 \
		-d unimp -semihosting-config enable,target=native \
		-m 1057 \
		-bios bl1.bin \
		-initrd rootfs.cpio.gz \
		-kernel Image -no-acpi \
		-append "console=ttyAMA0,38400 keep_bootcon root=/dev/vda2"


expect {
	"Kernel panic" {
		info "!!! Kernel panic\n"
		exit 1
	}
	timeout {
		info "!!! Timeout\n"
		exit 1
	}
	"ogin:"
}

send -- "root\r\r"
expect "# "
puts " done, guest is booted.\n"

send -- "cd test_hello/\r"
expect "# "
send -- "cp a6f77c1e-96fe-4a0e-9e74-262582a4c8f1.ta /lib/optee_armtz/\r"
expect "# "
send -- "./optee_ref_ta\r"
expect "# "

puts " done\n"
